{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-teal-50 via-blue-50 to-orange-50">
    <!-- Header -->
    <header class="border-b bg-white/80 backdrop-blur-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button onclick="toggleNav()" class="p-2 -ml-2 hover:bg-gray-100 rounded-full md:hidden">
                    <i data-lucide="menu" class="size-6 text-gray-700"></i>
                </button>
                <a href="{{ url_for('matching') }}"
                    class="hidden md:inline-flex items-center justify-center rounded-md w-10 h-10 hover:bg-muted transition-colors">
                    <i data-lucide="arrow-left" class="size-5"></i>
                </a>
                <h1 class="text-xl font-bold">My Profile</h1>
            </div>
            <button onclick="toggleEdit()" id="btn-edit"
                class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 text-sm font-medium">
                <i data-lucide="edit" class="size-4 mr-2"></i> Edit
            </button>
            <div class="hidden gap-2" id="edit-actions">
                <button onclick="cancelEdit()"
                    class="inline-flex items-center justify-center rounded-md border border-input bg-white hover:bg-accent h-10 px-4 py-2 text-sm font-medium">
                    Cancel
                </button>
                <button onclick="saveProfile()"
                    class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 text-sm font-medium">
                    <i data-lucide="save" class="size-4 mr-2"></i> Save
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Profile Card -->
        <div class="bg-white rounded-3xl shadow-lg p-8 mb-6">
            <div class="flex flex-col md:flex-row items-center gap-6">
                <div class="relative group">
                    <div class="size-32 rounded-full bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center text-6xl overflow-hidden"
                        id="avatar">
                        <!-- Populated by JS -->
                    </div>
                    <input type="file" id="photo-input" accept="image/*" class="hidden"
                        onchange="handlePhotoSelect(event)">
                    <button onclick="document.getElementById('photo-input').click()" id="photo-upload-btn"
                        class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                        <i data-lucide="camera" class="size-8 text-white"></i>
                    </button>
                </div>
                <div class="flex-1 text-center md:text-left">
                    <div class="flex items-center gap-2 justify-center md:justify-start mb-2">
                        <h2 class="text-2xl font-bold" id="display-name">...</h2>
                        <span id="badge-verified"
                            class="hidden flex items-center gap-1 px-2 py-1 bg-primary/10 rounded-full text-xs text-primary font-medium">
                            <i data-lucide="shield" class="size-3"></i> Verified
                        </span>
                    </div>
                    <p class="text-muted-foreground mb-4" id="display-age">...</p>
                    <div class="flex flex-wrap gap-2 justify-center md:justify-start" id="badges-container">
                        <!-- Badges -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Details Form -->
        <div class="bg-white rounded-3xl shadow-lg p-8 mb-6">
            <h3 class="text-xl mb-4 font-semibold">Profile Details</h3>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Display Name</label>
                    <input id="input-name"
                        class="flex h-12 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background disabled:cursor-not-allowed disabled:opacity-50"
                        disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Bio</label>
                    <textarea id="input-bio"
                        class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background disabled:cursor-not-allowed disabled:opacity-50"
                        disabled placeholder="Tell us a bit about yourself..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">What I Can Share</label>
                    <textarea id="input-share"
                        class="flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background disabled:cursor-not-allowed disabled:opacity-50"
                        disabled></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">What I Want to Learn</label>
                    <textarea id="input-learn"
                        class="flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background disabled:cursor-not-allowed disabled:opacity-50"
                        disabled></textarea>
                </div>
            </div>
        </div>

        <!-- Interests -->
        <div class="bg-white rounded-3xl shadow-lg p-8 mb-6">
            <h3 class="text-xl mb-4 font-semibold">Interests</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="interests-grid">
                <!-- JS Populated -->
            </div>
        </div>

        <!-- Settings -->
        <div class="bg-white rounded-3xl shadow-lg p-8">
            <h3 class="text-xl mb-6 font-semibold flex items-center gap-2">
                <i data-lucide="settings" class="size-5 text-gray-500"></i> Settings
            </h3>

            <!-- Font Size Setting -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-3 flex items-center gap-2">
                    <i data-lucide="type" class="size-4 text-gray-500"></i> Text Size
                </label>
                <div class="flex flex-wrap gap-2">
                    <button onclick="setFontSize('normal')" id="font-normal"
                        class="px-4 py-3 rounded-xl border-2 transition-all font-medium text-sm hover:border-primary">
                        A <span class="ml-1 text-gray-500">Normal</span>
                    </button>
                    <button onclick="setFontSize('large')" id="font-large"
                        class="px-4 py-3 rounded-xl border-2 transition-all font-medium text-lg hover:border-primary">
                        A <span class="ml-1 text-gray-500">Large</span>
                    </button>
                    <button onclick="setFontSize('xlarge')" id="font-xlarge"
                        class="px-4 py-3 rounded-xl border-2 transition-all font-medium text-xl hover:border-primary">
                        A <span class="ml-1 text-gray-500">Extra Large</span>
                    </button>
                </div>
                <p class="text-xs text-muted-foreground mt-2">Adjust text size for better readability</p>
            </div>

            <hr class="my-6 border-gray-200">

            <button onclick="logout()"
                class="inline-flex items-center justify-center rounded-md border border-destructive text-destructive hover:bg-destructive/10 h-10 px-4 py-2 text-sm font-medium w-full sm:w-auto">
                <i data-lucide="log-out" class="size-4 mr-2"></i> Sign Out
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null;
    let originalData = null;
    const ALL_INTERESTS = [
        "Cooking & Recipes", "History & Heritage", "Technology", "Music & Arts", "Life Stories",
        "Gardening", "Sports & Fitness", "Languages", "Travel", "Crafts & Hobbies",
    ];

    async function init() {
        const userStr = localStorage.getItem('user');
        if (!userStr) {
            window.location.href = '/login';
            return;
        }
       
        currentUser = JSON.parse(userStr);
       
        try {
            const res = await fetch('/api/users');
            if (res.ok) {
                const data = await res.json();
                const me = data.users.find(u => u.id === currentUser.id);
                if (me) {
                    currentUser = me;
                    localStorage.setItem('user', JSON.stringify(me));
                }
            }
        } catch (e) { }

        originalData = JSON.parse(JSON.stringify(currentUser));
        renderProfile();

        // Load and apply saved font size
        loadFontSize();
    }

    // Font size settings
    const FONT_SIZES = {
        'normal': '16px',
        'large': '20px',
        'xlarge': '24px'
    };

    function setFontSize(size) {
        localStorage.setItem('fontSize', size);
        applyFontSize(size);
        updateFontButtons(size);
        showToast(`Text size changed to ${size === 'xlarge' ? 'Extra Large' : size.charAt(0).toUpperCase() + size.slice(1)}`);
    }

    function applyFontSize(size) {
        document.documentElement.style.fontSize = FONT_SIZES[size] || FONT_SIZES['normal'];
    }

    function loadFontSize() {
        const savedSize = localStorage.getItem('fontSize') || 'normal';
        applyFontSize(savedSize);
        updateFontButtons(savedSize);
    }

    function updateFontButtons(activeSize) {
        ['normal', 'large', 'xlarge'].forEach(size => {
            const btn = document.getElementById(`font-${size}`);
            if (btn) {
                if (size === activeSize) {
                    btn.classList.add('border-primary', 'bg-primary/10');
                    btn.classList.remove('border-gray-200');
                } else {
                    btn.classList.remove('border-primary', 'bg-primary/10');
                    btn.classList.add('border-gray-200');
                }
            }
        });
    }

    function renderProfile() {
        document.getElementById('display-name').textContent = currentUser.name || "User";
        document.getElementById('display-age').textContent = `${currentUser.ageGroup === 'senior' ? 'Senior' : 'Youth'} â€¢ ${currentUser.email}`;
        // Avatar - show photo if available, else emoji
        const avatarEl = document.getElementById('avatar');
        if (currentUser.photo) {
            avatarEl.innerHTML = `<img src="${currentUser.photo}" alt="Profile" class="w-full h-full object-cover">`;
        } else {
            avatarEl.textContent = currentUser.ageGroup === 'senior' ? "ðŸ‘´" : "ðŸ§‘";
        }

        if (currentUser.verified) document.getElementById('badge-verified').classList.remove('hidden');

        // Inputs
        document.getElementById('input-name').value = currentUser.name || "";
        document.getElementById('input-bio').value = currentUser.bio || "";
        document.getElementById('input-share').value = currentUser.canShare || "";
        document.getElementById('input-learn').value = currentUser.wantToLearn || "";

        // Interests
        const grid = document.getElementById('interests-grid');
        grid.innerHTML = ALL_INTERESTS.map(i => {
            const has = (currentUser.interests || []).includes(i);
            return `
                <div class="flex items-center gap-3 p-3 rounded-xl border border-gray-200 transition-all ${has ? 'bg-primary/5 border-primary/30' : ''} ${isEditing ? 'cursor-pointer hover:border-primary/50' : 'cursor-default opacity-80'}" onclick="toggleInterest('${i}')" id="interest-${i}">
                    <div class="size-5 rounded border ${has ? 'bg-primary border-primary' : 'border-gray-300'} flex items-center justify-center">
                        ${has ? '<i data-lucide="check" class="size-3 text-white"></i>' : ''}
                    </div>
                    <span>${i}</span>
                </div>
            `;
        }).join('');
        lucide.createIcons();
    }

    let isEditing = false;
    function toggleEdit() {
        isEditing = true;
        document.getElementById('btn-edit').classList.add('hidden');
        document.getElementById('edit-actions').classList.remove('hidden');
        document.getElementById('edit-actions').classList.add('flex');

        ['input-name', 'input-bio', 'input-share', 'input-learn'].forEach(id => {
            document.getElementById(id).disabled = false;
        });

        // Make interests clickable visually (logic handled in toggleInterest)
        // Re-render handled
    }

    function cancelEdit() {
        isEditing = false;
        currentUser = JSON.parse(JSON.stringify(originalData));
        renderProfile();
        resetUI();
    }

    function resetUI() {
        document.getElementById('btn-edit').classList.remove('hidden');
        document.getElementById('edit-actions').classList.add('hidden');
        document.getElementById('edit-actions').classList.remove('flex');
        ['input-name', 'input-bio', 'input-share', 'input-learn'].forEach(id => document.getElementById(id).disabled = true);
    }

    function toggleInterest(interest) {
        if (!isEditing) return;

        if (!currentUser.interests) {
            currentUser.interests = [];
        }

        const list = currentUser.interests;
        if (list.includes(interest)) {
            currentUser.interests = list.filter(x => x !== interest);
        } else {
            currentUser.interests.push(interest);
        }
        renderProfile();
    }

    async function saveProfile() {
        // Collect inputs
        currentUser.name = document.getElementById('input-name').value;
        currentUser.bio = document.getElementById('input-bio').value;
        currentUser.canShare = document.getElementById('input-share').value;
        currentUser.wantToLearn = document.getElementById('input-learn').value;

        try {
            const res = await fetch('/api/profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: currentUser.id,
                    updates: currentUser
                })
            });
            const data = await res.json();
            if (data.success) {
                showToast('Profile updated!');
                originalData = JSON.parse(JSON.stringify(currentUser));
                localStorage.setItem('user', JSON.stringify(currentUser));
                isEditing = false;
                resetUI();
            } else {
                showToast('Error saving', 'error');
            }
        } catch (e) {
            showToast('Error saving', 'error');
        }
    }

    async function handlePhotoSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Show preview immediately
        const reader = new FileReader();
        reader.onload = function (e) {
            document.getElementById('avatar').innerHTML = `<img src="${e.target.result}" alt="Profile" class="w-full h-full object-cover">`;
        };
        reader.readAsDataURL(file);

        // Upload to server
        const formData = new FormData();
        formData.append('photo', file);
        formData.append('userId', currentUser.id);

        try {
            const res = await fetch('/api/profile/photo', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (data.success) {
                currentUser.photo = data.photoUrl;
                localStorage.setItem('user', JSON.stringify(currentUser));
                showToast('Photo updated!');
            } else {
                showToast(data.error || 'Error uploading photo', 'error');
            }
        } catch (e) {
            showToast('Error uploading photo', 'error');
        }
    }

    function logout() {
        if (confirm('Sign out?')) {
            localStorage.removeItem('user');
            window.location.href = '/';
        }
    }

    init();
</script>

{% endblock %}
