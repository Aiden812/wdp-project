{% extends 'base.html' %}

{% block content %}
<div class="h-screen flex flex-col bg-gradient-to-br from-teal-50 via-blue-50 to-orange-50">
    <!-- Header -->
    <header class="border-b bg-white/80 backdrop-blur-sm shadow-sm z-10">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button onclick="toggleNav()" class="p-2 -ml-2 hover:bg-gray-100 rounded-full md:hidden">
                    <i data-lucide="menu" class="size-6 text-gray-700"></i>
                </button>
                <a href="{{ url_for('matches_view') }}"
                    class="hidden md:inline-flex items-center justify-center rounded-md w-10 h-10 hover:bg-muted transition-colors">
                    <i data-lucide="arrow-left" class="size-5"></i>
                </a>
                <div class="flex items-center gap-2">
                    <h1 class="text-lg font-bold">Chat</h1>
                </div>
            </div>
            <div class="text-sm text-green-600 font-medium hidden" id="status-text">Connected</div>
        </div>
    </header>

    <div
        class="flex-1 flex overflow-hidden container mx-auto max-w-5xl h-full shadow-xl rounded-none md:rounded-xl md:my-4 md:border bg-white">
        <!-- Sidebar -->
        <div class="w-20 md:w-80 border-r bg-gray-50 flex flex-col">
            <div class="p-4 border-b hidden md:block">
                <h3 class="font-semibold text-gray-700">Conversations</h3>
            </div>
            <div class="flex-1 overflow-y-auto" id="conversation-list">
                <!-- Populated by JS -->
                <div class="p-4 text-center text-muted-foreground text-sm">Loading...</div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col h-full bg-white relative">
            <!-- Chat Header -->
            <div class="p-4 border-b flex items-center justify-between bg-white z-10" id="chat-header">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-full bg-gray-200 animate-pulse"></div>
                    <div class="space-y-2">
                        <div class="h-4 w-32 bg-gray-200 rounded animate-pulse"></div>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50" id="messages-container">
                <div class="text-center text-muted-foreground mt-10">Select a conversation to start chatting</div>
            </div>

            <!-- Input -->
            <div class="p-4 border-t bg-white">
                <form class="flex gap-2" onsubmit="sendMessage(event)">
                    <button type="button" class="p-2 text-muted-foreground hover:bg-gray-100 rounded-full"
                        title="Get conversation suggestions" onclick="togglePrompts()">
                        <i data-lucide="lightbulb" class="size-5"></i>
                    </button>
                    <input type="text" id="message-input"
                        class="flex-1 rounded-full border border-gray-300 px-4 py-2 focus:outline-none focus:border-primary"
                        placeholder="Type a message..." disabled>
                    <button type="submit" id="send-btn"
                        class="size-10 rounded-full bg-primary text-secondary flex items-center justify-center hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                        <i data-lucide="send" class="size-5 text-white"></i>
                    </button>
                </form>

                <!-- Prompts -->
                <div id="prompts-area" class="hidden mt-2 p-2 bg-yellow-50 rounded-xl border border-yellow-200">
                    <p class="text-xs font-semibold text-yellow-800 mb-2 uppercase tracking-wide">Conversation Starters
                    </p>
                    <div class="flex flex-wrap gap-2 text-sm">
                        <button
                            class="px-3 py-1 bg-white border border-yellow-300 rounded-full text-yellow-900 hover:bg-yellow-100"
                            onclick="usePrompt('Share a childhood memory')">Share a childhood memory</button>
                        <button
                            class="px-3 py-1 bg-white border border-yellow-300 rounded-full text-yellow-900 hover:bg-yellow-100"
                            onclick="usePrompt('Teach me something new')">Teach me something new</button>
                        <button
                            class="px-3 py-1 bg-white border border-yellow-300 rounded-full text-yellow-900 hover:bg-yellow-100"
                            onclick="usePrompt('What is your hobby?')">What is your hobby?</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null;
    let currentMatchId = null;
    let currentConvId = null;
    let matches = [];
    let socket = null;

    async function init() {
        const userStr = localStorage.getItem('user');
        if (!userStr) {
            window.location.href = '/login';
            return;
        }
        currentUser = JSON.parse(userStr);

        // Initialize Socket.IO connection
        socket = io();

        // Listen for new messages
        socket.on('new_message', (data) => {
            console.log('Received message:', data);
            if (data.conversationId === currentConvId) {
                // Add message to current chat
                appendMessage(data.message);
            } else {
                // Show notification for other chats
                const sender = matches.find(m => data.conversationId.includes(m.id));
                if (sender) {
                    showToast(`New message from ${sender.name}!`, 'success');
                    // Play notification sound
                    playNotificationSound();
                }
            }
        });

        // Listen for typing indicators
        socket.on('user_typing', (data) => {
            if (data.userId !== currentUser.id) {
                showTypingIndicator();
            }
        });

        socket.on('connect', () => {
            console.log('Socket connected');
            document.getElementById('status-text').classList.remove('hidden');
        });

        socket.on('disconnect', () => {
            console.log('Socket disconnected');
            document.getElementById('status-text').classList.add('hidden');
        });

        // Initial load
        await loadMatches();

        // Check URL params for auto-select
        const params = new URLSearchParams(window.location.search);
        const withId = params.get('with');
        if (withId && matches.find(m => m.id === withId)) {
            selectMatch(withId);
        } else if (matches.length > 0) {
            selectMatch(matches[0].id);
        }
    }

    function playNotificationSound() {
        // Simple beep using Web Audio API
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (e) { }
    }

    function showTypingIndicator() {
        // Could add a "user is typing..." indicator
    }

    function appendMessage(msg) {
        const container = document.getElementById('messages-container');
        const isMe = msg.senderId === currentUser.id;
        const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const msgDiv = document.createElement('div');
        msgDiv.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
        msgDiv.innerHTML = `
            <div class="max-w-[80%] ${isMe ? 'bg-primary text-white rounded-tr-none' : 'bg-white border text-gray-800 rounded-tl-none'} rounded-2xl px-4 py-2 shadow-sm">
                <p class="text-sm md:text-base">${msg.text}</p>
                <p class="text-[10px] ${isMe ? 'text-blue-100' : 'text-gray-400'} mt-1 text-right">${time}</p>
            </div>
        `;
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
    }

    async function loadMatches() {
        try {
            const res = await fetch(`/api/matches?userId=${currentUser.id}`);
            const data = await res.json();
            if (data.success) {
                matches = data.matches;
                renderMatches();
            }
        } catch (e) { console.error(e); }
    }

    function renderMatches() {
        const list = document.getElementById('conversation-list');
        if (matches.length === 0) {
            list.innerHTML = '<div class="p-4 text-center text-gray-500">No matches yet. Go swipe!</div>';
            return;
        }
        list.innerHTML = matches.map(m => `
            <div onclick="selectMatch('${m.id}')" class="p-3 hover:bg-gray-100 cursor-pointer border-l-4 ${currentMatchId === m.id ? 'border-primary bg-blue-50' : 'border-transparent'} transition-all flex items-center gap-3">
                <div class="size-10 rounded-full bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center text-xl flex-shrink-0 overflow-hidden">
                    ${m.photo ? `<img src="${m.photo}" alt="${m.name}" class="w-full h-full object-cover">` : (m.ageGroup === 'senior' ? 'ðŸ‘´' : 'ðŸ§‘')}
                </div>
                <div class="hidden md:block min-w-0">
                    <div class="font-semibold text-gray-900 truncate">${m.name}</div>
                    <div class="text-xs text-gray-500 truncate">Click to chat</div>
                </div>
            </div>
        `).join('');
    }

    async function selectMatch(matchId) {
        // Leave previous room if any
        if (currentConvId && socket) {
            socket.emit('leave', { conversationId: currentConvId });
        }

        currentMatchId = matchId;
        renderMatches(); // Re-render to update active state

        const match = matches.find(m => m.id === matchId);
        if (!match) return;

        // Calculate conversation ID and join WebSocket room
        currentConvId = [currentUser.id, matchId].sort().join('-');
        if (socket) {
            socket.emit('join', { conversationId: currentConvId });
            console.log('Joined room:', currentConvId);
        }

        // Update header
        const header = document.getElementById('chat-header');
        header.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-full bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center text-xl overflow-hidden">
                    ${match.photo ? `<img src="${match.photo}" alt="${match.name}" class="w-full h-full object-cover">` : (match.ageGroup === 'senior' ? 'ðŸ‘´' : 'ðŸ§‘')}
                </div>
                <div>
                    <h3 class="font-bold flex items-center gap-2">
                        ${match.name}
                        ${match.verified ? '<i data-lucide="shield" class="size-3 text-primary"></i>' : ''}
                    </h3>
                    <p class="text-xs text-muted-foreground">${match.ageGroup === 'senior' ? 'Senior' : 'Youth'}</p>
                </div>
            </div>
            <button class="p-2 text-destructive hover:bg-destructive/10 rounded-full" title="Report User">
                <i data-lucide="flag" class="size-5"></i>
            </button>
        `;
        lucide.createIcons();

        // Enable input
        document.getElementById('message-input').disabled = false;
        document.getElementById('send-btn').disabled = false;

        loadMessages(matchId, true);
    }

    async function loadMessages(matchId, scrollToBottom = false) {
        const convId = [currentUser.id, matchId].sort().join('-');
        try {
            const res = await fetch(`/api/messages/${convId}`);
            const data = await res.json();
            if (data.success) {
                renderMessages(data.messages, scrollToBottom);
            }
        } catch (e) {
            console.error('Error loading messages', e);
        }
    }

    function renderMessages(messages, doScroll) {
        const container = document.getElementById('messages-container');

        if (messages.length === 0) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-muted-foreground">
                    <div class="bg-primary/10 p-4 rounded-full mb-2">
                        <i data-lucide="message-circle" class="size-8 text-primary"></i>
                    </div>
                    <p>No messages yet.</p>
                    <p class="text-sm">Say hello to start the conversation!</p>
                </div>
            `;
            lucide.createIcons();
            return;
        }

        const html = messages.map(msg => {
            const isMe = msg.senderId === currentUser.id;
            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[80%] ${isMe ? 'bg-primary text-white rounded-tr-none' : 'bg-white border text-gray-800 rounded-tl-none'} rounded-2xl px-4 py-2 shadow-sm">
                        <p class="text-sm md:text-base">${msg.text}</p>
                        <p class="text-[10px] ${isMe ? 'text-blue-100' : 'text-gray-400'} mt-1 text-right">${time}</p>
                    </div>
                </div>
            `;
        }).join('');

        // Only update if changed prevents flicker/scroll jump if we were careful, but replace for now
        if (container.innerHTML !== html) {
            container.innerHTML = html;
            if (doScroll) container.scrollTop = container.scrollHeight;
        }
        lucide.createIcons();
    }

    async function sendMessage(e) {
        e.preventDefault();
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if (!text || !currentMatchId) return;

        input.value = '';
        const convId = [currentUser.id, currentMatchId].sort().join('-');

        try {
            const res = await fetch('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversationId: convId,
                    message: {
                        senderId: currentUser.id,
                        text: text // Note: API expects message object, db.py handles timestamps
                    }
                })
            });
            const data = await res.json();
            if (data.success) {
                loadMessages(currentMatchId, true);
            }
        } catch (e) {
            showToast('Error sending message', 'error');
        }
    }

    function togglePrompts() {
        document.getElementById('prompts-area').classList.toggle('hidden');
    }

    function usePrompt(text) {
        document.getElementById('message-input').value = text;
        document.getElementById('prompts-area').classList.add('hidden');
        document.getElementById('message-input').focus();
    }

    init();
</script>
{% endblock %}